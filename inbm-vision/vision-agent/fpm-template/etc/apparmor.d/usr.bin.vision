#include <tunables/global>

/usr/bin/vision {
  #include <abstractions/base>
  #include <abstractions/bash>
  #include <abstractions/nameservice>
  #include <abstractions/python>

  capability setuid,
  capability setgid,
  capability dac_override,
  capability sys_admin,
  capability sys_resource,
  capability audit_write,
  deny /* w,

  /bin/uname rix,  # required for secure xlink
  /dev/tty wr,
  /dev/xlnk wr,
  /dev/xlnksecure wr,
  /etc/* r,
  /etc/intel-manageability/public/mqtt-ca/mqtt-ca.crt r,
  /etc/intel-manageability/public/vision-agent/intel_manageability_vision.conf rw,
  /etc/intel-manageability/public/vision-agent/intel_manageability_vision.conf_bak rw,
  /etc/intel-manageability/public/vision-agent/logging.ini r,
  /etc/intel-manageability/public/vision-agent/vision-agent.crt r,
  /etc/intel-manageability/secret/vision-agent/vision-agent.key r,
  /etc/ssl/openssl.cnf r,  # required for secure xlink
  /etc/pam.d/* r,
  /etc/security/* r,
  /etc/default/locale r,
  /run/utmp kr,
  /proc/*/fd/ r,
  /proc/*/stat r,
  /sbin/ldconfig rix,
  /sbin/ldconfig.real rix,
  /tmp/** mrw,
  /usr/bin/lspci rix,
  /usr/bin/vision rix,
  /usr/bin/tee ix,
  /usr/bin/vision-flashless/flashless rix,
  /usr/bin/x86_64-linux-gnu-ld.bfd ix,
  /usr/bin/x86_64-linux-gnu-gcc-7 ix,
  /usr/bin/dpkg-query ix,
  /usr/lib/ r,
  /usr/lib/libPmsPython rm,
  /usr/lib/firmware/flashless_backup/* rw,
  /usr/lib/firmware/* rwix,
  /usr/share/configuration-manager/*.xsd r,
  /usr/share/vision-agent/*.xsd r,
  /usr/share/misc/pci.ids r,
  /usr/share/file/magic/ r,
  /usr/share/misc/magic.mgc r,
  /var/cache/manageability/** rwix,
  /var/tmp/** mrw,
  /var/lib/dpkg/** r,
  /lib/firmware/intel-flashless/* rwix,
  /lib/firmware/flashless_backup/* rwix,
  /lib/firmware/* rwix,
  /lib/*/security/* m,
  /sys/class/net/ r,
  /sys/devices/** r,
  /sys/bus/pci/** r,
  /sys/devices/virtual/pcie_vd/** rw,
  /sys/xlink-core-events/* rw,
  /bin/cat rix,
  /bin/grep ix,
  /bin/echo ix,
  /opt/xlink_provision/* rw,
  /usr/bin/file rix,
  /usr/** r,
}
